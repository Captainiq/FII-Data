<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FII/DII Market Trend Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 20px; background-color: #f0f2f5; color: #1a202c; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .card { border: 1px solid #e2e8f0; padding: 15px; border-radius: 10px; background: #fff; }
        h1, h2 { text-align: center; color: #2d3748; }
        .positive { color: #38a169; font-weight: bold; }
        .negative { color: #e53e3e; font-weight: bold; }
        .indicator-box { text-align: center; padding: 20px; margin: 20px 0; border-radius: 10px; font-size: 1.2em; font-weight: bold; }
        .buying-exhaustion { background: #fff5f5; color: #c53030; border: 2px solid #feb2b2; }
        .selling-exhaustion { background: #f0fff4; color: #2f855a; border: 2px solid #9ae6b4; }
        .neutral-box { background: #edf2f7; color: #4a5568; }
        canvas { max-height: 350px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <h1>FII/DII Pro Analysis Dashboard</h1>
    
    <div id="momentumIndicator" class="indicator-box neutral-box">Analyzing Market Momentum...</div>

    <div class="grid">
        <div class="card">
            <h2>Daily Cash Flow (Cr)</h2>
            <canvas id="dailyChart"></canvas>
        </div>
        <div class="card">
            <h2>Cumulative FII Flow (The Big Picture)</h2>
            <canvas id="cumulativeChart"></canvas>
        </div>
    </div>

    <div class="card" style="margin-top: 20px;">
        <h2>Recent Data Snapshot</h2>
        <div id="tableContainer"></div>
    </div>
</div>

<script>
    const SPREADSHEET_ID = '12e5NUDJQXnyB2V27WynpgGw2Gwg4oxqefc8jVOyy3aM';
    const API_KEY = 'AIzaSyBYXp1ILH81N2lo_oPn6mGvju0hpyWTHFI';
    const RANGE = 'FII-DII!A1:G100'; 

    async function init() {
        try {
            const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY}`);
            const data = await res.json();
            const rows = data.values.slice(1).filter(r => r[0]); 
            
            // Logic: Process data (Chronological for charts)
            const cleanData = rows.map(r => ({
                date: r[0],
                fii: parseFloat(r[1].replace(/,/g, '')) || 0,
                dii: parseFloat(r[2].replace(/,/g, '')) || 0,
                futures: parseFloat(r[3].replace(/,/g, '')) || 0
            }));

            renderDashboard(cleanData);
        } catch (err) {
            document.getElementById('momentumIndicator').innerHTML = "Error loading data. Check Sheet sharing settings.";
        }
    }

    function renderDashboard(data) {
        // 1. Calculate Cumulative Flow
        let cumulative = 0;
        const cumulativeData = data.map(d => {
            cumulative += d.fii;
            return cumulative;
        });

        const labels = data.map(d => d.date);

        // 2. Momentum Indicator Logic
        const last3 = data.slice(-3);
        const latestFii = last3[last3.length-1].fii;
        const prevFii = last3[last3.length-2].fii;
        const indicator = document.getElementById('momentumIndicator');

        if (latestFii < 0 && latestFii > prevFii) {
            indicator.className = "indicator-box selling-exhaustion";
            indicator.innerHTML = "SIGNAL: SELLING EXHAUSTION (Bottoming Out?)";
        } else if (latestFii > 0 && latestFii < prevFii) {
            indicator.className = "indicator-box buying-exhaustion";
            indicator.innerHTML = "SIGNAL: BUYING EXHAUSTION (Near Top?)";
        } else {
            indicator.className = "indicator-box neutral-box";
            indicator.innerHTML = latestFii < 0 ? "BIAS: BEARISH PRESSURE" : "BIAS: BULLISH MOMENTUM";
        }

        // 3. Daily Chart
        new Chart(document.getElementById('dailyChart'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'FII Cash', data: data.map(d => d.fii), backgroundColor: '#fc8181' },
                    { label: 'DII Cash', data: data.map(d => d.dii), backgroundColor: '#63b3ed' }
                ]
            }
        });

        // 4. Cumulative Chart (The Trend Line)
        new Chart(document.getElementById('cumulativeChart'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Cumulative FII Net Flow',
                    data: cumulativeData,
                    borderColor: '#4a5568',
                    fill: true,
                    backgroundColor: 'rgba(203, 213, 224, 0.3)',
                    tension: 0.3
                }]
            }
        });
    }

    init();
</script>
</body>
</html>
