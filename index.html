<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FII Sentiment Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container { max-width: 1200px; margin-top: 50px; }
        .ratio-gauge { height: 200px; }
        .ratio-card { text-align: center; padding: 20px; border-radius: 10px; }
        .bullish { background-color: #d4edda; color: #155724; }
        .bearish { background-color: #f8d7da; color: #721c24; }
        .neutral { background-color: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">FII Index Sentiment Dashboard</h1>
        <div class="row">
            
            <div class="col-md-4">
                <div id="signal-card" class="ratio-card mb-4">
                    <h3>Latest Signal</h3>
                    <p id="current-signal" class="fs-1 fw-bold">Loading...</p>
                    <p>FII Long/Short Ratio: <span id="current-ratio"></span></p>
                </div>
            </div>

            <div class="col-md-8">
                <h3 class="mb-3">30-Day Net FII Index Futures Trend</h3>
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <hr class="my-5">

        <h3 class="mb-3">Last 5 Trading Days</h3>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Long Contracts</th>
                    <th>Short Contracts</th>
                    <th>Net Contracts (L-S)</th>
                    <th>Long Ratio (%)</th>
                </tr>
            </thead>
            <tbody id="dataTableBody">
                </tbody>
        </table>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            fetch('/api/data')
                .then(response => response.json())
                .then(data => {
                    const history = data.history;
                    const latest = data.latest;

                    if (history.length > 0) {
                        renderTrendChart(history);
                        updateSignalCard(latest);
                        updateDataTable(history.slice(-5).reverse());
                    }
                })
                .catch(error => console.error('Error fetching data:', error));
        });

        // Function to determine sentiment based on the ratio
        function getSentiment(ratio) {
            if (ratio >= 60) return { signal: "STRONG BULLISH", class: "bullish" };
            if (ratio >= 50) return { signal: "MILD BULLISH", class: "neutral" };
            if (ratio <= 40) return { signal: "STRONG BEARISH", class: "bearish" };
            return { signal: "CAUTIOUS NEUTRAL", class: "neutral" };
        }

        function updateSignalCard(latest) {
            const sentiment = getSentiment(latest.long_ratio);
            document.getElementById('current-signal').textContent = sentiment.signal;
            document.getElementById('current-ratio').textContent = `${latest.long_ratio}%`;
            document.getElementById('signal-card').className = `ratio-card mb-4 ${sentiment.class}`;
        }

        function updateDataTable(history) {
            const tableBody = document.getElementById('dataTableBody');
            history.forEach(item => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = item.date;
                row.insertCell().textContent = item.long_contracts.toLocaleString();
                row.insertCell().textContent = item.short_contracts.toLocaleString();
                row.insertCell().textContent = item.net_contracts.toLocaleString();
                row.insertCell().textContent = `${item.long_ratio.toFixed(2)}%`;
            });
        }

        function renderTrendChart(history) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            // Data for the Line Chart (Net Contracts)
            const labels = history.map(item => item.date);
            const netData = history.map(item => item.net_contracts);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Net FII Contracts (Long - Short)',
                        data: netData,
                        backgroundColor: netData.map(value => value > 0 ? 'rgba(75, 192, 192, 0.8)' : 'rgba(255, 99, 132, 0.8)'),
                        borderColor: netData.map(value => value > 0 ? 'rgba(75, 192, 192, 1)' : 'rgba(255, 99, 132, 1)'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'Net Contracts' }
                        },
                        x: {
                            title: { display: true, text: 'Date' }
                        }
                    },
                    plugins: {
                        legend: { display: true },
                        title: { display: false }
                    }
                }
            });
              
        }
    </script>
</body>
</html>
